tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - indigo_custom_types: https://raw.githubusercontent.com/indigo-dc/tosca-types/master/custom_types.yaml

description: >
  TOSCA examples for specifying a Chronos Job that runs an application using the input stored at some URL and uploads the output data to a Swift container (using Swift auth 1 or Keystone)

topology_template:

  inputs:

    input_urls:
      type: list
      description: List of input files that will be downloaded in the job sandbox (archives will be automatically uncompressed)
      entry_schema:
        type: string
      required: yes
      # Example: [ 'https://gist.githubusercontent.com/maricaantonacci/d7ab0832f895c14dde504a41f8d65017/raw/de803bdc6d62b3836b34c833ffac2408f77c18af/run-job-onedata.sh', 'http://download.maxmind.com/download/worldcities/worldcitiespop.txt.gz' ] 

    input_filenames:
      type: string
      description: csv list of input file names
      required: no
      # Example: 'worldcitiespop.txt'  

    output_protocol:
      type: string
      description: Protocol that will be used to upload the output generated by the job
      constraints:
         - valid_values: [ swift+keystone, swift ]
      required: yes
      default: 'swift+keystone'
  
    output_endpoint:
      type: string
      description: 'Auth URL of the Swift cluster (e.g. https://keystone-server.example.com:5000/v2.0 or http://swift-auth-server.example.com/auth/v1.0)'
      required: yes
  
    output_path:
      type: string
      description: Swift Container were the output files will be uploaded
      required: yes
  
    output_username:
      type: string 
      description: Username to access the swift account
      required: yes
  
    output_password:
      type: string
      description: Password to access the swift account 
      required: yes
  
    output_tenant:
      type: string
      description: 'keystone user tenant - required in case of authentication against keystone (protocol == swift+keystone)'
      required: no
      default: ''
  
    output_region:
      type: string 
      description: Swift region required in case of ambiguity
      default: ''
      required: no
  
    output_filenames:
      type: string
      description: List of filenames generated by the application run
      required: yes
  
    command:
      type: string
      description: Command to execute
      # Example: "cd $MESOS_SANDBOX && /bin/bash run-job-onedata.sh"
      required: no
  
    cpus:
      type: float
      description: Amount of CPUs for this job
      required: yes
      default: 1.0
    
    mem:
      type: scalar-unit.size
      description: Amount of Memory for this job
      required: yes
      default: 1 GB
  
    docker_image:
      type: string
      description: Docker image to be used to run the container application
      required: yes
      # Example: "marica/ubuntu:16.04-oneclient"
       

  node_templates:

    chronos_job:
      type: tosca.nodes.indigo.Container.Application.Docker.Chronos
      properties:
        description: 'Execute Application'
        command: { get_input: command }
        uris: { get_input: input_urls}
        retries: 1
        force_pull_image: true
        environment_variables:
          INPUT_FILENAMES: { get_input: input_filenames }
          OUTPUT_FILENAMES: { get_input: output_filenames }
          ## The values for the following env vars are automatically provided by the Orchestrator
          ONEDATA_SERVICE_TOKEN: { get_attribute : [ onedata_service_space, token ] }
          ONEDATA_SPACE: { get_attribute : [ onedata_service_space, space ] }
          ONEDATA_PATH: { get_attribute : [ onedata_service_space, path ] }
          ONEDATA_PROVIDERS: { get_attribute : [ onedata_service_space, selected_provider ] }
      artifacts:
        image:
          file: { get_input: docker_image }
          type: tosca.artifacts.Deployment.Image.Container.Docker
      requirements:
        - host: docker_runtime1


    onedata_service_space:
      type: tosca.nodes.indigo.OnedataServiceSpace
      properties:
        smartScheduling: true


    chronos_job_upload:
      type: tosca.nodes.indigo.Container.Application.Docker.Chronos
      properties:
        description: 'Upload  application output data'
        command: /bin/bash run.sh
        force_pull_image: true
        retries: 1
        environment_variables:
          OUTPUT_PROTOCOL: { get_input: output_protocol }
          OUTPUT_ENDPOINT: { get_input: output_endpoint }
          OUTPUT_PATH: { get_input: output_path }
          OUTPUT_USERNAME: { get_input: output_username }
          OUTPUT_PASSWORD: { get_input: output_password }
          OUTPUT_TENANT: { get_input: output_tenant }
          OUTPUT_REGION: { get_input: output_region }
          OUTPUT_FILENAMES: { get_input: output_filenames }
          ## The values for the following env vars are automatically provided by the Orchestrator
          ONEDATA_SERVICE_TOKEN: { get_attribute : [ onedata_service_space, token ] }
          ONEDATA_SPACE: { get_attribute : [ onedata_service_space, space ] }
          ONEDATA_PATH: { get_attribute : [ onedata_service_space, path ] }
          ONEDATA_PROVIDERS: { get_attribute : [ onedata_service_space, selected_provider ] }
      artifacts:
        image:
          file: indigodatacloud/chronos-job-upload
          type: tosca.artifacts.Deployment.Image.Container.Docker
      requirements:
        - host: docker_runtime2
        - parent_job: chronos_job


    docker_runtime1:
      type: tosca.nodes.indigo.Container.Runtime.Docker
      capabilities:
        host:
          properties:
            num_cpus: { get_input: cpus }
            mem_size: { get_input: mem }


    docker_runtime2:
      type: tosca.nodes.indigo.Container.Runtime.Docker
      capabilities:
        host:
          properties:
            num_cpus: 1.0
            mem_size: 1024 MB

